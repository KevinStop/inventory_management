import{b as m,d as o}from"./chunk-LQDACG22.js";import{B as i,S as c,X as h,a as u,b as p,p as l,t as d}from"./chunk-ETUY2JGY.js";var b=class a{constructor(e){this.http=e}apiUrl=`${o.apiUrl}/requests`;userId=null;initialize(){this.http.get(`${o.apiUrl}/users/me`,{withCredentials:!0}).pipe(d(e=>{this.userId=e.userId}),i(e=>(console.error("Error al obtener los detalles del usuario:",e),this.userId=null,l(null)))).subscribe()}getRequestsByFilter(e){let t={};return e.status&&(t.status=e.status),e.isActive!==void 0&&(t.isActive=e.isActive),e.userId&&(t.userId=e.userId),this.http.get(this.apiUrl,{withCredentials:!0,params:t})}getRequestById(e){return this.http.get(`${this.apiUrl}/${e}`,{withCredentials:!0})}createRequest(e,t,r){if(!this.userId)throw console.error("Error: Usuario no autenticado"),new Error("Usuario no autenticado");let n=new FormData;return n.append("userId",this.userId.toString()),n.append("description",e.description||""),n.append("typeRequest",e.typeRequest||""),n.append("returnDate",e.returnDate||""),n.append("responsible",e.responsible||""),n.append("status",e.status||"pendiente"),n.append("requestDetails",JSON.stringify(t)),r&&n.append("file",r,r.name),this.http.post(`${this.apiUrl}/`,n,{withCredentials:!0}).pipe(i(s=>{throw s.error&&s.error.error&&s.error.error.includes("disponibilidad")&&console.error("Error de disponibilidad:",s.error),s}))}updateRequest(e){return this.http.put(`${this.apiUrl}/${e}`,{},{withCredentials:!0})}deleteRequest(e){return this.http.delete(`${this.apiUrl}/${e}`,{withCredentials:!0})}rejectRequest(e,t){return this.http.post(`${this.apiUrl}/${e}/reject`,{rejectionNotes:t},{withCredentials:!0})}updateReturnDate(e,t){return this.http.put(`${this.apiUrl}/${e}/return-date`,{newReturnDate:t},{withCredentials:!0})}markAsNotReturned(e,t){let r=t?{adminNotes:t}:{};return this.http.put(`${this.apiUrl}/${e}/not-returned`,r,{withCredentials:!0})}getNotReturnedLoans(){return this.http.get(`${this.apiUrl}/not-returned`,{withCredentials:!0})}finalizeRequest(e,t){let r=t?{adminNotes:t}:{};return this.http.put(`${this.apiUrl}/${e}/finalize`,r,{withCredentials:!0})}canMarkAsNotReturned(e){return e.status==="prestamo"}canFinalize(e){return["prestamo","no_devuelto"].includes(e.status)}getSelectedComponents(){let e=localStorage.getItem("selectedComponents");return e?JSON.parse(e):[]}setSelectedComponents(e){localStorage.setItem("selectedComponents",JSON.stringify(e))}getSelectedComponentCount(){return this.getSelectedComponents().reduce((t,r)=>t+r.quantity,0)}addSelectedComponentToStorage(e,t){if(t>e.availableQuantity)throw new Error(`La cantidad solicitada (${t}) excede la disponibilidad (${e.availableQuantity})`);if(!this.userId){this.http.get(`${o.apiUrl}/users/me`,{withCredentials:!0}).pipe(d(r=>{this.userId=r.userId,this.addComponentToLocalStorage(e,t)}),i(r=>(console.error("Error al obtener el ID del usuario:",r),l(null)))).subscribe();return}this.addComponentToLocalStorage(e,t)}addComponentToLocalStorage(e,t){let r=this.getSelectedComponents(),n=r.findIndex(s=>s.id===e.id);n!==-1?r[n].quantity=t:r.push(p(u({},e),{quantity:t})),this.setSelectedComponents(r)}removeSelectedComponentFromStorage(e){let t=this.getSelectedComponents();t=t.filter(r=>r.id!==e),this.setSelectedComponents(t)}getComprobante(e){return this.http.get(e,{responseType:"blob"})}static \u0275fac=function(t){return new(t||a)(h(m))};static \u0275prov=c({token:a,factory:a.\u0275fac,providedIn:"root"})};export{b as a};
